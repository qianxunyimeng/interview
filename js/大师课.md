# 渡一大师课笔记

## 如何理解JS的异步？

JS是一门单线程的语言，这是因为它运行在浏览器的渲染主线程中，而渲染主线程只有一个。而渲染主线程承担着诸多工作，渲染页面、执行JS都在其中运行。如果使用同步的方式，就极有可能导致主线程产生阻塞，从而导致消息队列中的很多任务无法得到执行。所以浏览器采用异步的方式，当某些任务发生时，主线程将任务交给其它线程去处理，自身立即结束任务的执行，转而执行后续代码。当其它线程完成时，将事先传递的回调函数包装成任务，加入到消息队列末尾排队。

## 简述一下JS的事件循环

事件循环又叫消息循环，是浏览器渲染主线程的工作方式。
在谷歌浏览器源码中，它开启一个不会结束的for循环，每次循环从消息队列中取出第一个任务执行，而其它线程只需在合适的时候将任务加到队列末尾即可。
过去把消息队列简单分为宏队列和微队列，这种说法目前无法满足复杂的浏览器环境，取而代之是一种更加灵活多变的处理方式。根据W3C官方解释，每个任务有不同的类型，同类型的任务必须在同一队列，不同的任务可以属于不同的队列。不同的任务队列有不同的优先级，在一次事件循环中，由浏览器自行决定取哪一个队列的任务。但浏览器必须有一个微队列，微队列的任务一定具有最高的优先级，必须优先调度执行。

## 浏览器是如何渲染页面的？

当浏览器的网络线程收到html文档后,会产生一个渲染任务，并将其push到渲染主线程的消息队列。在事件循环机制的作用下，渲染主线程取出消息队列中的渲染任务，开始渲染。
整个渲染流程分为多个阶段，分别是: HTML解析、样式计算、布局、分层、绘制、分块、光栅话、画。

### html解析

解析html字符串形成 DOM树和CSSOM树。
解析过程中遇到css解析css,遇到js执行js。为了提高解析效率，浏览器在开始解析前，会开启一个预解析线程，率先下载外链的css和js。
CSS不会阻塞html解析。
渲染主线程遇到js时必须暂停一切行为，转而去下载解析执行js后，才会继续解析html。这是因为js代码在执行过程中可能会修改单前的DOM树或css树。

### 样式计算

主线程会遍历得到的DOM树，依次为树中每个节点计算出它最终的样式，称之为Computed Style。
在这一过程中，很多预设值会变为绝对值，比如red会变为 rgb(255,0,0);相对单位变成绝对单位，比如em变成px。
这一步完成后，会得到一颗带有样式的dom树

### 布局

遍历DOM树的每一个节点，计算节点的几何信息。例如节点的宽高、相对包含块的位置。
大部分时候，DOM树和布局树并非是一一对应关系。比如: display:none的节点没有几何信息，因此不会生成到布局树中，伪元素、匿名行盒、匿名块盒都会导致DOM树和布局树无法一一对应。

### 分层

主线程会使用一套复杂的策略对整个布局树进行分层。分层的好处在于，将来改变某一层后，仅仅只是对该层进行后续处理，从而提升效率。
滚动条、堆叠上下文、transform、opacity等样式或多或少会影响分层结果，也可以通过 will-change属性更大程度的影响分层结果。

### 绘制 Paint

为每一层单独产生绘制指令集，用于描述这一层的内容该如何画出来。完成绘制后，主线程将每个图层的绘制信息提交给合成线程，剩余步骤交给合成线程完成。

到此渲染主线程完成所有工作，后续工作交给其它线程

### 分块 Tiling

分块会将每一层分为多个小的区域，分块的工作是交给多个线程同时进行的
分块是发生合成线程

### 光栅化 Raster

光栅化是将每个块变成位图(像素点信息)，优先处理靠近视口的块。此过程会用到GPU加速

### 画 Draw

合成线程拿到每个层、每个块的位图后，生成一个个指引(quad)信息。
指引会标识出每个位图应该画到屏幕的哪个位置，以及会考虑到旋转、缩放等变形。
变形发生在合成线程，与渲染主线程无关，这就是transform效率高的本质原因。
合成线程会把quad提交给GPU进程,由GPU进程产生系统调用，提交给GPU硬件，完成最终的屏幕成像。

## 回流和重绘

### 回流 reflow

回流(重排)是指DOM的变化影响到元素的几何属性(宽和高等)，浏览器会重新计算元素的几何属性，会使渲染树中受到影响的部分失效，并重新构建渲染树。
reflow的本质就是重新计算layout树。
改动属性造成的reflow是异步完成的，因此，当JS获取布局属性时，可能造成无法获取到最新的布局信息，浏览器反复权衡下，决定获取属性产生一个同步任务立即reflow

### 重绘

渲染树需要更新属性，这些属性只会影响元素的外观，风格，不会影响布局
